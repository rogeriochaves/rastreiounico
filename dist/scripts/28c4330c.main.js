!function(){window.Rastreiounico=Ember.Application.create();Ember.View.reopen({didInsertElement:function(){this._super(),this.get("controller")&&this.get("controller").afterRender&&this.get("controller").afterRender()},willDestroyElement:function(){this._super(),this.get("controller")&&this.get("controller").beforeDestroy&&this.get("controller").beforeDestroy()}})}(),function(){Rastreiounico.IndexController=Ember.Controller.extend({init:function(){}})}(),function(){Rastreiounico.RastreioEditController=Ember.Controller.extend({initialLocation:null,last_lat:0,last_lng:0,browserSupportFlag:new Boolean,map:null,marker:null,circle:null,alreadyAsked:!1,allowed:!1,reclamou:!1,updateLocationInterval:null,mapInterval:null,resizeInterval:null,email:null,beforeDestroy:function(){clearInterval(this.updateLocationInterval),clearInterval(this.mapInterval),clearInterval(this.resizeInterval),$(window).off("resize")},afterRender:function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||$("#qrcode").show().animate({bottom:"0%"},500),$("#qrcode .btt-close").click(function(){$("#qrcode").animate({bottom:"-100%"},500)}),$(window).resize(this.onResize);new ZeroClipboard($("#lnk-copiar"));self=this,self.last_lat=0,self.last_lng=0,self.marker=null,self.circle=null,self.map=null,self.mapInterval=setInterval(function(){"undefined"!=typeof google&&(self.onMapLoad(),clearInterval(self.mapInterval))},1e3)},onResize:function(){$("#mapa").height($(window).height()-$("header").outerHeight(!0)),this.map&&google.maps.event.trigger(this.map,"resize")},onMapLoad:function(){var a=this;if(a.onResize(),a.map=new google.maps.Map($("#mapa")[0],{zoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP}),resizeInterval=setInterval(function(){a.onResize()},1e3),navigator.geolocation){a.browserSupportFlag=!0;var b=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,c="undefined"!=typeof InstallTrigger,d=(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,!!window.chrome&&!b,!1||document.documentMode);setTimeout(function(){a.allowed||$(".ative-localizacao").show()},2500),c?($(".ative-localizacao").addClass("firefox"),$(".ative-localizacao p").html("Precisamos que você clique em <b>Compartilhar Localização > Sempre Compartilhar Localização</b> para continuar")):d&&($(".ative-localizacao").addClass("ie"),$(".ative-localizacao p").html("Precisamos que você clique em <b>Opções deste site > Sempre Permitir</b> para continuar")),a.updateLocationInterval=setInterval(a.updateLocation(a),1e3),a.updateLocation()}else a.browserSupportFlag=!1,handleNoGeolocation(a.browserSupportFlag)},updateLocation:function(a){return function(){return a.alreadyAsked&&!a.allowed?!1:(a.alreadyAsked=!0,void navigator.geolocation.getCurrentPosition(function(b){a.allowed=!0,$(".ative-localizacao, .ative-localizacao-fade").hide();var c=b.coords.accuracy,d=b.coords.latitude,e=b.coords.longitude;if(d&&e&&!isNaN(d)&&!isNaN(e)&&(Math.abs(a.last_lat-d)>1e-6||Math.abs(a.last_lng-e)>1e-6)){if(a.initialLocation=new google.maps.LatLng(d,e),a.map.setCenter(a.initialLocation),a.marker)a.marker.setPosition(a.initialLocation),a.circle.setCenter(a.initialLocation),a.circle.setRadius(c),a.circle.setMap(10>c?null:a.map);else{var f=new google.maps.MarkerImage($("#marker").attr("src"),null,new google.maps.Point(0,0),new google.maps.Point(12.5,12.5));a.marker=new google.maps.Marker({position:a.initialLocation,title:"Você está aqui",icon:f,map:a.map}),a.circle=new google.maps.Circle({center:a.initialLocation,radius:c,map:a.map,fillColor:"#1faee3",fillOpacity:.2,strokeColor:"#1faee3",strokeOpacity:.4}),a.map.fitBounds(a.circle.getBounds()),a.map.setZoom(18)}a.last_lat=d,a.last_lng=e,setTimeout(function(){a.map.setCenter(a.initialLocation)},500);var g=a.get("model");g.set("lat",d),g.set("lng",e),g.save()}},function(){handleNoGeolocation(a.browserSupportFlag)},{enableHighAccuracy:!0}))}},handleNoGeolocation:function(a){self.reclamou||($(".ative-localizacao").hide(),alert(1==a?"Você bloqueou a localização automática para esta página, por favor, permita a localização automática e atualize a página":"Seu navegador não suporta localização automática, por favor, utilize outro navegador"),self.reclamou=!0)},actions:{enviarEmail:function(a){var a=this.get("email"),b=this.get("model");if(a.match(/([^\s]+)((?:[-a-z0-9]\.)[a-z]{2,})([a-z ])?/i)){if(b){var c=new mandrill.Mandrill("aLX0qXmlZDUoot3glnWBRw"),d={message:{from_email:"rastreiounico@gmail.com",to:[{email:a}],subject:"Código de Rastreio Rastreio Único",text:"Olá,\n\nVocê recebeu um código de rastreio, acesse o link abaixo e acompanhe:\n\n"+b.get("full_url_with_protocol")}};$("#enviar-email").modal("hide"),c.messages.send(d,function(){alert("Email Enviado!")},function(a){console.log("Erro: "+a)})}}else alert("Email inválido")}}})}(),function(){Rastreiounico.RastreioShowController=Ember.Controller.extend({initialLocation:null,last_lat:0,last_lng:0,browserSupportFlag:new Boolean,map:null,marker:null,mapInterval:null,resizeInterval:null,modelDbConnection:null,afterRender:function(){$(window).resize(this.onResize),self=this,self.last_lat=0,self.last_lng=0,self.marker=null,self.map=null,self.mapInterval=setInterval(function(){"undefined"!=typeof google&&(self.onMapLoad(),clearInterval(self.mapInterval))},1e3),self.modelDbConnection=null},onResize:function(){$("#mapa").height($(window).height()-$("header").outerHeight(!0)),this.map&&google.maps.event.trigger(this.map,"resize")},beforeDestroy:function(){clearInterval(this.mapInterval),clearInterval(this.resizeInterval),$(window).off("resize"),self.modelDbConnection&&self.modelDbConnection.off("child_changed")},onMapLoad:function(){var a=this;a.onResize(),a.map=new google.maps.Map($("#mapa")[0],{zoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP}),resizeInterval=setInterval(function(){a.onResize()},1e3),a.updateLocation(),a.setModelChangeListener()},updateLocation:function(){var a=this,b=a.get("model");if(b&&a.map){var c=b.get("lat"),d=b.get("lng");if(a.initialLocation=new google.maps.LatLng(c,d),a.map.setCenter(a.initialLocation),a.marker)a.marker.setPosition(a.initialLocation);else{var e=new google.maps.MarkerImage($("#marker").attr("src"),null,new google.maps.Point(0,0),new google.maps.Point(12.5,12.5));a.marker=new google.maps.Marker({position:a.initialLocation,title:"Você está aqui",icon:e,map:a.map}),a.map.setZoom(18)}a.last_lat=c,a.last_lng=d}}.observes("model.lat","model.lng"),setModelChangeListener:function(){var a=this,b=a.get("model");b&&(a.modelDbConnection=new Firebase("https://scorching-fire-178.firebaseio.com/rastreios/"+b.get("id")),a.modelDbConnection.on("child_changed",function(a){"lat"==a.name()?b.set("lat",a.val()):"lng"==a.name()&&b.set("lng",a.val())}))}.observes("model")})}(),function(){Rastreiounico.RastreiosNewController=Ember.Controller.extend({afterRender:function(){var a,b={},c=this.store,d=this;Rastreiounico.dbAuthCallback=function(e,f){if(e)alert(e);else if(f&&b.id!=f.id)Rastreiounico.dbAuth.logout();else if(f){if(f){c.createRecord("rastreio",{user_id:f.id+"",lat:0,lng:0,description:"Nenhuma descrição"}).save().then(function(b){d.transitionToRoute("/rastreio/"+b.get("id")+"/"+a,b)})}}else a=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}(),Rastreiounico.dbAuth.createUser(a+"@rastreiounico.com.br",a,function(c,d){c?alert(c):(b=d,Rastreiounico.dbAuth.login("password",{email:a+"@rastreiounico.com.br",password:a,debug:!0}))})},Rastreiounico.dbAuthCallback(null,Rastreiounico.dbLoggedUser)}})}(),function(){Rastreiounico.db=new Firebase("https://scorching-fire-178.firebaseio.com"),Rastreiounico.dbLoggedUser=null,Rastreiounico.dbAuthCallback=function(a,b){a?alert(a):Rastreiounico.dbLoggedUser=b},Rastreiounico.dbAuth=new FirebaseSimpleLogin(Rastreiounico.db,function(a,b){Rastreiounico.dbAuthCallback(a,b)}),Rastreiounico.ApplicationAdapter=DS.FirebaseAdapter.extend({firebase:Rastreiounico.db})}(),function(){Rastreiounico.Rastreio=DS.Model.extend({user_id:DS.attr("string"),lat:DS.attr("number"),lng:DS.attr("number"),description:DS.attr("string"),bitly_url:DS.attr("string"),full_url:function(){return window.location.host+window.location.pathname+"#/rastreio/"+this.get("id")}.property("id"),full_url_with_protocol:function(){return window.location.protocol+"//"+this.get("full_url")}.property("id"),bitly_link:function(){var a=this;return a.get("id")?a.get("bitly_url")?a.get("bitly_url"):($.getJSON("http://api.bitly.com/v3/shorten?callback=?",{format:"json",apiKey:"R_32a8cf74a50d660fcb5639b1db99358d",login:"rogeriocfj",longUrl:a.get("full_url_with_protocol").replace("localhost","lvh.me")},function(b){b.data&&b.data.url?a.set("bitly_url",b.data.url):a.set("bitly_url",a.get("full_url_with_protocol"))}),a.set("bitly_url",""),null):null}.property("bitly_url","id"),bitly_link_without_http:function(){return(this.get("bitly_link")?this.get("bitly_link"):"").replace("https://","").replace("http://","")}.property("bitly_url")})}(),function(){Rastreiounico.ApplicationRoute=Ember.Route.extend({model:function(){return["red","yellow","blue"]}})}(),function(){Rastreiounico.RastreioShowRoute=Ember.Route.extend({model:function(a){return this.store.find("rastreio",a.rastreio_id)}}),Rastreiounico.RastreioEditRoute=Ember.Route.extend({model:function(a){return this.set("password",a.password),this.store.find("rastreio",a.rastreio_id)},afterModel:function(){var a=this.modelFor(this.routeName),b=this.controllerFor(this.routeName),c=this.get("password"),d={};b.set("qrcode","http://chart.apis.google.com/chart?cht=qr&chs=150x150&chl="+encodeURIComponent(a.get("full_url_with_protocol")+"/"+c)),Rastreiounico.dbAuthCallback=function(e,f){e?(alert(e),self.transitionToRoute("/rastreio/"+a.get("id"))):f&&d.id!=a.user_id?Rastreiounico.dbAuth.logout():f?b.set("current_usuario",f):Rastreiounico.dbAuth.login("password",{email:c+"@rastreiounico.com.br",password:c,debug:!0})},Rastreiounico.dbAuthCallback(null,Rastreiounico.dbLoggedUser)}})}(),function(){Rastreiounico.MapaPrincipalView=Ember.View.extend({templateName:"mapa_principal",didInsertElement:function(){function a(){function a(a){b=1==a?c:c,f.setCenter(b)}var e={zoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,center:c},f=new google.maps.Map(this.$("#mapa-principal")[0],e);navigator.geolocation?(d=!0,navigator.geolocation.getCurrentPosition(function(a){b=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),f.setCenter(b)},function(){a(d)})):(d=!1,a(d))}var b,c=new google.maps.LatLng(-22.066441,-42.924029),d=new Boolean;a()}})}(),function(){Rastreiounico.Router.map(function(){this.resource("rastreios",{path:"/rastreios"},function(){this.route("new")}),this.resource("rastreio.show",{path:"/rastreio/:rastreio_id"}),this.resource("rastreio.edit",{path:"/rastreio/:rastreio_id/:password"})})}();